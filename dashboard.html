<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Inventaris TKJ</title>
  <link rel="stylesheet" href="style.css" />
  <!-- SheetJS CDN untuk export XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<script>
  
  // guard sederhana: jika belum login -> kembali ke index
  (function(){
    const role = localStorage.getItem('userRole');
    if (!role) { location.href = 'index.html'; }
  })();
</script>

  <div class="container">
    <h1>Dashboard Inventaris Peralatan TKJ</h1>
    <button class="logout" onclick="logout()">Logout</button>

    <!-- Form tambah / edit (hanya admin) -->
    <div class="form-container" id="admin-form">
      <h2>Tambah / Edit Peralatan</h2>
      <form id="form">
        <!-- Tambahkan hidden id untuk edit -->
        <input type="hidden" id="form-id" />
        <input type="text" id="form-nisn" placeholder="NISN (opsional)" />
        <input type="text" id="form-nama" placeholder="Nama Peralatan" required />
        <input type="text" id="form-kode" placeholder="Kode / Serial" />
        <input type="number" id="form-jumlah" placeholder="Jumlah" required min="1" />

        <!-- Scan QR dipindahkan ke bawah Jumlah -->
        <div style="margin:10px 0;">
          <button type="button" id="admin-scan-btn" onclick="window.location.href='qr-scanner.html'">Scan QR</button>
        </div>

        <!-- Status tetap setelah tombol scan -->
        <select id="form-status">
          <option value="Baik">Dipinjam</option>
          <option value="Rusak">Rusak</option>
        </select>

        <!-- FOTO: paste area 1 & 2 -->
        <div style="display:flex;gap:8px;margin-top:8px;align-items:flex-start">
          <div style="text-align:center">
            <label>Paste Image 1 (Ctrl+V)</label>
            <div id="paste-area-1" contenteditable="true" style="width:160px;height:120px;border:1px dashed rgba(255,255,255,0.06);border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.01)"></div>
            <img id="preview-1" src="" alt="" style="display:block;margin-top:6px;max-width:160px;max-height:120px;border-radius:6px;" />
            <input type="hidden" id="form-foto1" />
            <div><button type="button" onclick="document.getElementById('form-foto1').value=''; document.getElementById('preview-1').src='';">Clear</button></div>
          </div>
          <div style="text-align:center">
            <label>Paste Image 2 (Ctrl+V)</label>
            <div id="paste-area-2" contenteditable="true" style="width:160px;height:120px;border:1px dashed rgba(255,255,255,0.06);border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.01)"></div>
            <img id="preview-2" src="" alt="" style="display:block;margin-top:6px;max-width:160px;max-height:120px;border-radius:6px;" />
            <input type="hidden" id="form-foto2" />
            <div><button type="button" onclick="document.getElementById('form-foto2').value=''; document.getElementById('preview-2').src='';">Clear</button></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">Simpan</button>
          <button type="button" onclick="resetForm()">Batal</button>
        </div>
      </form>
    </div>

    <div class="buttons-row" id="admin-buttons">
      <button onclick="exportCSV()" class="excel-btn">Export CSV</button>
      <button onclick="exportXLSX()" class="excel-btn">Export XLSX</button>
      <button id="history-btn" onclick="window.location.href='history.html'" class="excel-btn">Riwayat Peminjaman</button>
      <!-- tombol Scan QR dihapus sesuai permintaan -->
    </div>

    <!-- FORM KHUSUS USER: buat permintaan pinjam (hanya untuk role 'user') -->
    <div id="borrow-container" class="form-container" style="display:none;margin-bottom:12px">
      <h2>Formulir Permintaan Pinjam</h2>
      <form id="borrow-form">
        <input type="text" id="pinjam-nama" placeholder="Nama Barang / Deskripsi" required />
        <input type="text" id="pinjam-kode" placeholder="Kode / Serial (opsional)" />
        <input type="number" id="pinjam-jumlah" placeholder="Jumlah" required min="1" />
        <input type="text" id="pinjam-alasan" placeholder="Alasan / Lokasi pemakaian" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="submit">Kirim Permintaan</button>
          <button type="button" onclick="document.getElementById('borrow-form').reset()">Batal</button>
          <!-- tombol scan khusus user -->
          <button type="button" id="user-scan-btn" onclick="window.location.href='qr-scanner.html'">Scan QR</button>
        </div>
      </form>
      <p class="note">Permintaan Anda akan tersimpan dan dapat diverifikasi oleh admin.</p>
    </div>

    <!-- Tabel inventaris (disembunyikan untuk user) -->
    <h2 id="table-title">Daftar Inventaris</h2>
    <div class="table-container" id="inventory-table">
      <table>
        <thead>
          <tr>
            <th>Foto + QR</th>
            <th>NISN</th>
            <th>Nama</th>
            <th>Kode</th>
            <th>Jumlah</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tabel-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Notifikasi (harus diload sebelum script utama karena script utama memanggil fungsi notif) -->
  <script src="notif.js"></script>
  <script src="excel.js"></script>
  <script src="ui-anim.js"></script>
  <script src="script.js"></script>

  <!-- Role based UI -->
  <script>
    (function(){
      const role = localStorage.getItem('userRole');
      const username = localStorage.getItem('username') || 'guest';
      if (!role) { location.href = 'index.html'; return; }

      // default: hide user-only UI
      document.getElementById('borrow-container').style.display = 'none';

      if (role === 'user') {
        // Sembunyikan elemen admin
        const adminForm = document.getElementById('admin-form');
        const adminStats = document.getElementById('admin-stats');
        const adminButtons = document.getElementById('admin-buttons');
        const inventory = document.getElementById('inventory-table');
        const tableTitle = document.getElementById('table-title');

        if (adminForm) adminForm.style.display = 'none';
        if (adminStats) adminStats.style.display = 'none';
        if (adminButtons) adminButtons.style.display = 'none';
        if (inventory) inventory.style.display = 'none';
        if (tableTitle) tableTitle.style.display = 'none';

        // Tampilkan form pinjam untuk user
        document.getElementById('borrow-container').style.display = 'block';
      } else {
        // admin sees everything
        document.getElementById('borrow-container').style.display = 'none';
      }

      // Jika ada hasil scan terakhir, isi form pinjam otomatis (kemudian hapus)
      const lastScan = localStorage.getItem('lastScan');
      if (lastScan && document.getElementById('pinjam-nama')) {
        try {
          // Asumsi: QR berisi JSON atau teks "nama|kode"
          let parsed = lastScan;
          try { parsed = JSON.parse(lastScan); } catch(e){ /* not json */ }
          if (typeof parsed === 'object') {
            if (parsed.nama) document.getElementById('pinjam-nama').value = parsed.nama;
            if (parsed.kode) document.getElementById('pinjam-kode').value = parsed.kode;
          } else if (typeof parsed === 'string') {
            // format: "nama|kode" atau plain kode
            if (parsed.includes('|')) {
              const parts = parsed.split('|');
              document.getElementById('pinjam-nama').value = parts[0] || '';
              document.getElementById('pinjam-kode').value = parts[1] || '';
            } else {
              // isi kode jika string singkat, atau nama jika lebih deskriptif
              if (parsed.length <= 8) document.getElementById('pinjam-kode').value = parsed;
              else document.getElementById('pinjam-nama').value = parsed;
            }
          }
        } catch(err){ console.warn('prefill error', err); }
        // hapus setelah dipakai
        localStorage.removeItem('lastScan');
      }

      // handle pengiriman permintaan pinjam (disimpan lokal sebagai demo)
      const borrowForm = document.getElementById('borrow-form');
      if (borrowForm) {
        borrowForm.addEventListener('submit', function(e){
          e.preventDefault();
          const nama = document.getElementById('pinjam-nama').value.trim();
          const kode = document.getElementById('pinjam-kode').value.trim();
          const jumlah = parseInt(document.getElementById('pinjam-jumlah').value,10) || 1;
          const alasan = document.getElementById('pinjam-alasan').value.trim();

          const req = {
            id: 'req_' + Date.now(),
            user: username,
            nama, kode, jumlah, alasan,
            status: 'pending',
            createdAt: new Date().toISOString()
          };

          const list = JSON.parse(localStorage.getItem('borrow_requests') || '[]');
          list.push(req);
          localStorage.setItem('borrow_requests', JSON.stringify(list));

          alert('Permintaan pinjam terkirim. Tunggu verifikasi oleh admin.');
          borrowForm.reset();
        });
      }
    })();
  </script>
  <script>
(function(){
  const form = document.getElementById('form');
  if (!form) return;

  form.addEventListener('submit', function(e){
    e.preventDefault();

    // Ambil nilai dari input (sesuaikan id jika berbeda)
    const idEl = document.getElementById('form-id'); // optional, untuk edit
    const nisn = document.getElementById('form-nisn')?.value.trim() || '';
    const nama = document.getElementById('form-nama')?.value.trim() || '';
    const kode = document.getElementById('form-kode')?.value.trim() || '';
    const jumlah = parseInt(document.getElementById('form-jumlah')?.value, 10) || 1;
    const status = document.getElementById('form-status')?.value || 'Baik';
  const id = idEl?.value || 'item_' + Date.now();

    if (!nama) { alert('Nama peralatan harus diisi.'); return; }

    // Simpan ke localStorage (key: items) â€” struktur array objek
    const items = JSON.parse(localStorage.getItem('items') || '[]');

    const existingIndex = items.findIndex(it => it.id === id);
  // include pasted images if any
  const foto1 = document.getElementById('form-foto1')?.value || '';
  const foto2 = document.getElementById('form-foto2')?.value || '';
  const item = { id, nisn, nama, kode, jumlah, status, foto1, foto2, updatedAt: new Date().toISOString() };

    if (existingIndex >= 0) {
      items[existingIndex] = item;
    } else {
      items.push(item);
    }

    localStorage.setItem('items', JSON.stringify(items));

    // Reset form dan update tampilan
    resetForm();

    // Jika ada fungsi tampilkanData/tampilData di script lain, panggil; kalau tidak reload agar data muncul
    if (typeof tampilkanData === 'function') {
      try { tampilkanData(); } catch(e){ location.reload(); }
    } else if (typeof renderInventory === 'function') {
      try { renderInventory(items); } catch(e){ location.reload(); }
    } else {
      location.reload();
    }
  });

  // Expose resetForm agar tombol Batal/JS lain bisa pakai
  window.resetForm = function(){
    const ids = ['form-id','form-nisn','form-nama','form-kode','form-jumlah','form-status'];
    ids.forEach(i => { const el = document.getElementById(i); if (el) el.value = ''; });
    const statusEl = document.getElementById('form-status');
    if (statusEl) statusEl.value = 'Baik';
    // clear pasted images
    const f1 = document.getElementById('form-foto1'); if (f1) f1.value = '';
    const f2 = document.getElementById('form-foto2'); if (f2) f2.value = '';
    const p1 = document.getElementById('preview-1'); if (p1) p1.src = '';
    const p2 = document.getElementById('preview-2'); if (p2) p2.src = '';
  };
})();
  </script>
  <script>
  function renderInventory() {
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const tableBody = document.getElementById('tabel-body');
    tableBody.innerHTML = ''; // Kosongkan tabel sebelum merender ulang

    items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="display:flex;gap:6px;align-items:center;">
          ${item.foto1 ? `<img src="${item.foto1}" style="width:60px;height:40px;object-fit:cover;border-radius:6px" />` : ''}
          ${item.foto2 ? `<img src="${item.foto2}" style="width:60px;height:40px;object-fit:cover;border-radius:6px" />` : ''}
        </td>
        <td>${item.nisn}</td>
        <td>${item.nama}</td>
        <td>${item.kode}</td>
        <td>${item.jumlah}</td>
        <td>${item.status}</td>
        <td>
          <button onclick="editItem('${item.id}')">Edit</button>
          <button onclick="deleteItem('${item.id}')">Hapus</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function editItem(id) {
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const item = items.find(it => it.id === id);
    if (item) {
      document.getElementById('form-id').value = item.id;
      document.getElementById('form-nisn').value = item.nisn;
      document.getElementById('form-nama').value = item.nama;
      document.getElementById('form-kode').value = item.kode;
      document.getElementById('form-jumlah').value = item.jumlah;
      document.getElementById('form-status').value = item.status;
      // populate pasted images previews
      if (item.foto1) { document.getElementById('form-foto1').value = item.foto1; document.getElementById('preview-1').src = item.foto1; }
      if (item.foto2) { document.getElementById('form-foto2').value = item.foto2; document.getElementById('preview-2').src = item.foto2; }
    }
  }

  function deleteItem(id) {
    let items = JSON.parse(localStorage.getItem('items') || '[]');
    items = items.filter(it => it.id !== id);
    localStorage.setItem('items', JSON.stringify(items));
    renderInventory(); // Render ulang tabel setelah menghapus
  }

  // Panggil renderInventory saat halaman dimuat
  document.addEventListener('DOMContentLoaded', renderInventory);

  // Paste handling: capture image blobs from clipboard and convert to base64
  function blobToDataURL(blob, cb) {
    const reader = new FileReader();
    reader.onload = function(e) { cb(e.target.result); };
    reader.readAsDataURL(blob);
  }

  function handlePasteEvent(e, targetInputId, previewImgId) {
    if (!e.clipboardData) return;
    const items = e.clipboardData.items || [];
    for (let i=0;i<items.length;i++){
      const it = items[i];
      if (it.type && it.type.indexOf('image') !== -1) {
        const blob = it.getAsFile();
        blobToDataURL(blob, (dataUrl) => {
          const hidden = document.getElementById(targetInputId);
          const preview = document.getElementById(previewImgId);
          if (hidden) hidden.value = dataUrl;
          if (preview) preview.src = dataUrl;
        });
        e.preventDefault();
        return;
      }
    }
  }

  // Attach paste listeners to both paste areas
  const paste1 = document.getElementById('paste-area-1');
  const paste2 = document.getElementById('paste-area-2');
  if (paste1) paste1.addEventListener('paste', (e) => handlePasteEvent(e, 'form-foto1','preview-1'));
  if (paste2) paste2.addEventListener('paste', (e) => handlePasteEvent(e, 'form-foto2','preview-2'));
</script>
</body>
</html>

